name: Build and Sign Termux for Android Emacs

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Passo 0: Restaurar o cache dos downloads
      - name: Cache downloaded files
        id: cache-downloads
        uses: actions/cache@v4
        with:
          path: |
            termux.apk
            emacs.apk
            emacs.keystore
          key: ${{ runner.os }}-downloads-${{ hashFiles('**/build-and-sign.yml') }}

      - name: Download required files
        if: steps.cache-downloads.outputs.cache-hit != 'true'
        run: |
          echo "Cache not found. Downloading files..."
          echo "Downloading Termux APK from F-Droid..."
          wget -O termux.apk "https://f-droid.org/repo/com.termux_1022.apk"
          
          echo "Downloading Emacs signing key..."
          wget -O emacs.keystore "https://raw.githubusercontent.com/emacs-mirror/emacs/master/java/emacs.keystore"
          
          echo "Downloading Emacs APK from SourceForge..."
          wget -O emacs.apk "https://sourceforge.net/projects/android-ports-for-gnu-emacs/files/termux/emacs-30.1.90-29-arm64-v8a.apk/download"

      # PASSO 2 (CORRIGIDO): Configurar o Android SDK de forma explícita e confiável
      - name: Set up Android SDK
        uses: maxim-lobanov/setup-android-actions@v1
        with:
          api-level: 34 # Qualquer API level recente (ex: Android 14)
          build-tools: 35.0.0 # A mesma versão que estava dando erro, mas agora instalada corretamente
          # Esta ação automaticamente adiciona as build-tools ao PATH

      # Passo 3: Assinar o APK (AGORA COM O COMANDO SIMPLES)
      - name: Sign Termux APK
        run: |
          echo "Signing Termux APK with Emacs key..."
          # Como a ação adicionou as build-tools ao PATH, podemos chamar 'apksigner' diretamente!
          apksigner sign --v2-signing-enabled --ks emacs.keystore -debuggable-apk-permitted --ks-pass pass:emacs1 termux.apk

      - name: Verify APK signature
        run: |
          echo "Verifying Termux APK signature..."
          apksigner verify -v termux.apk

      - name: Upload APKs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-emacs-termux-apks
          path: |
            termux.apk
            emacs.apk
